<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KGBCREST</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Cascadia Code', 'Consolas', 'Courier New', monospace;
            background: #0c0c0c;
            min-height: 100vh;
            color: #e8e3d5;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Header */
        header {
            border-bottom: 1px solid #3c414b;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        header h1 {
            color: #f6c453;
            font-size: 1.5rem;
            font-weight: normal;
        }
        header h1::before { content: 'ðŸ” '; }
        header p {
            color: #7b7f87;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #3c414b;
            padding-bottom: 10px;
        }
        .tab-btn {
            padding: 8px 20px;
            border: 1px solid #3c414b;
            background: #0c0c0c;
            color: #7b7f87;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: #e8e3d5;
            border-color: #5c616b;
        }
        .tab-btn.active {
            background: #1e2d23;
            color: #f6c453;
            border-color: #f6c453;
        }

        /* Panels */
        .tab-content {
            display: none;
            background: #1a1a1a;
            border: 1px solid #3c414b;
            padding: 20px;
        }
        .tab-content.active { display: block; }

        /* Form elements */
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            color: #f6c453;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        label::before { content: '> '; color: #7b7f87; }

        /* File input */
        .file-drop {
            padding: 20px;
            background: #0c0c0c;
            border: 1px dashed #3c414b;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #7b7f87;
            font-size: 0.85rem;
        }
        .file-drop:hover {
            border-color: #00d4ff;
            color: #e8e3d5;
        }
        .file-drop.loaded {
            border-color: #3fb950;
            border-style: solid;
            color: #3fb950;
        }
        .file-drop input { display: none; }

        /* Preview */
        .preview {
            margin: 15px 0;
            padding: 10px;
            background: #0c0c0c;
            border: 1px solid #3c414b;
            text-align: center;
        }
        .preview img {
            max-width: 100%;
            max-height: 250px;
        }

        /* Capacity */
        .capacity {
            background: #0c0c0c;
            padding: 10px 15px;
            border-left: 3px solid #3fb950;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #e8e3d5;
        }
        .capacity.warning { border-color: #f0883e; }
        .capacity.danger { border-color: #f85149; }

        /* Textarea */
        textarea {
            width: 100%;
            padding: 12px;
            background: #0c0c0c;
            border: 1px solid #3c414b;
            color: #e8e3d5;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
        }
        textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }
        textarea::placeholder { color: #5c5c5c; }

        /* Buttons */
        .btn {
            padding: 10px 25px;
            border: 1px solid #3c414b;
            background: #0c0c0c;
            color: #e8e3d5;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            border-color: #00d4ff;
            color: #00d4ff;
        }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #1e2d23;
            border-color: #f6c453;
            color: #f6c453;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2a3d2e;
        }
        .btn-secondary { margin-left: 10px; }

        /* Status */
        .status {
            margin-top: 15px;
            padding: 10px 15px;
            font-size: 0.85rem;
            display: none;
            border-left: 3px solid #3c414b;
            background: #0c0c0c;
        }
        .status.show { display: block; }
        .status.success { border-color: #3fb950; color: #3fb950; }
        .status.error { border-color: #f85149; color: #f85149; }
        .status.loading { border-color: #00d4ff; color: #00d4ff; }

        /* Output */
        .output {
            margin-top: 20px;
            padding: 15px;
            background: #0c0c0c;
            border: 1px solid #3c414b;
            text-align: center;
        }
        .output h3 {
            color: #f6c453;
            font-size: 0.9rem;
            font-weight: normal;
            margin-bottom: 15px;
        }
        .output img {
            max-width: 100%;
            max-height: 350px;
            margin-bottom: 15px;
        }

        /* Decoded message */
        .decoded-msg {
            background: #0c0c0c;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #3c414b;
            font-size: 0.9rem;
        }
        .decoded-msg strong {
            color: #f6c453;
            display: block;
            margin-bottom: 10px;
        }
        .decoded-msg p {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #e8e3d5;
        }

        /* Source status */
        .source-status {
            padding: 8px 12px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            border-left: 3px solid #3fb950;
            background: #0c0c0c;
            color: #7b7f87;
        }
        .source-status.error {
            border-color: #f85149;
        }

        /* Separator */
        hr {
            border: none;
            border-top: 1px solid #3c414b;
            margin: 15px 0;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #3c414b;
            color: #5c5c5c;
            font-size: 0.8rem;
        }

        /* Hidden text (asterisks) */
        textarea.hidden-text {
            -webkit-text-security: disc;
            font-family: text-security-disc, 'Cascadia Code', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>KGBCREST</h1>
            <p>Kingry Graphical Book Cipher Compression Resistant Encrypted Steganography Tool</p>
            <p>Book cipher with DCT watermarking</p>
        </header>

        <div class="source-status" id="source-status">Loading source text...</div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('encode')">[ Encode ]</button>
            <button class="tab-btn" onclick="switchTab('decode')">[ Decode ]</button>
        </div>

        <!-- ENCODE TAB -->
        <div id="encode-tab" class="tab-content active">
            <div class="form-group">
                <label>Source Image</label>
                <div class="file-drop" id="image-drop">
                    <input type="file" id="image-file" accept="image/*">
                    Click to select image (PNG, JPEG, WebP)
                </div>
            </div>

            <div class="preview" id="encode-preview" style="display:none">
                <img id="preview-img">
            </div>

            <div class="capacity" id="capacity" style="display:none">
                <span id="capacity-text"></span>
            </div>

            <div class="form-group">
                <label>Message</label>
                <textarea id="message" placeholder="Enter your message here..." oninput="updateCount()"></textarea>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:5px">
                    <small id="char-count" style="color:#7b7f87;font-size:0.8rem">0 characters</small>
                    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;margin:0">
                        <input type="checkbox" id="hide-message" onchange="toggleHideMessage()" style="cursor:pointer">
                        <span style="color:#7b7f87;font-size:0.8rem">Hide</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>AES-256 Password (optional)</label>
                <input type="password" id="encode-password" placeholder="Leave empty for no encryption" style="width:100%;padding:10px;background:#0c0c0c;border:1px solid #3c414b;color:#e8e3d5;font-family:inherit;font-size:0.9rem">
                <small style="color:#7b7f87;font-size:0.75rem">If set, the message will be encrypted before encoding</small>
            </div>

            <button class="btn btn-primary" id="encode-btn" onclick="encode()" disabled>Encode Message</button>

            <div class="status" id="encode-status"></div>

            <div class="output" id="encode-output" style="display:none">
                <h3>Encoded Image</h3>
                <img id="encoded-img">
                <div>
                    <button class="btn" onclick="download('png')">Save PNG</button>
                    <button class="btn btn-secondary" onclick="download('webp')">Save WebP</button>
                </div>
            </div>
        </div>

        <!-- DECODE TAB -->
        <div id="decode-tab" class="tab-content">
            <div class="form-group">
                <label>Encoded Image</label>
                <div class="file-drop" id="decode-image-drop">
                    <input type="file" id="decode-image-file" accept="image/*">
                    Click to select the encoded image
                </div>
            </div>

            <div class="preview" id="decode-preview" style="display:none">
                <img id="decode-preview-img">
            </div>

            <div class="form-group">
                <label>AES-256 Password (if encrypted)</label>
                <input type="password" id="decode-password" placeholder="Leave empty if not encrypted" style="width:100%;padding:10px;background:#0c0c0c;border:1px solid #3c414b;color:#e8e3d5;font-family:inherit;font-size:0.9rem">
            </div>

            <button class="btn btn-primary" id="decode-btn" onclick="decode()" disabled>Decode Message</button>

            <div class="status" id="decode-status"></div>

            <div class="decoded-msg" id="decoded-output" style="display:none">
                <strong>Decoded Message:</strong>
                <p id="decoded-text"></p>
            </div>
        </div>

        <footer>Â© 2026 Adam Kingry</footer>
    </div>

    <script>
        const API = '';
        let imageLoaded = false;
        let decodeImageLoaded = false;
        let maxChars = 0;
        let encodedImageData = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        function setupFileDrop(dropId, inputId, handler) {
            const drop = document.getElementById(dropId);
            const input = document.getElementById(inputId);
            if (!drop || !input) return;
            drop.onclick = () => input.click();
            input.onchange = () => handler(input.files[0]);
            drop.ondragover = e => { e.preventDefault(); drop.style.borderColor = '#00d4ff'; };
            drop.ondragleave = () => drop.style.borderColor = '';
            drop.ondrop = e => {
                e.preventDefault();
                drop.style.borderColor = '';
                if (e.dataTransfer.files.length) handler(e.dataTransfer.files[0]);
            };
        }

        async function loadImage(file) {
            const reader = new FileReader();
            reader.onload = async e => {
                const img = new Image();
                img.onload = async () => {
                    document.getElementById('encode-preview').style.display = 'block';
                    document.getElementById('preview-img').src = e.target.result;
                    const drop = document.getElementById('image-drop');
                    drop.classList.add('loaded');
                    drop.textContent = 'âœ“ ' + file.name;
                    try {
                        const res = await fetch(API + '/api/capacity', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({width: img.width, height: img.height})
                        });
                        const data = await res.json();
                        maxChars = data.maxChars;
                        document.getElementById('capacity').style.display = 'block';
                        document.getElementById('capacity-text').textContent = 
                            'Capacity: ~' + maxChars + ' chars (' + img.width + 'Ã—' + img.height + ')';
                        imageLoaded = true;
                        updateButtons();
                        updateCount();
                    } catch (e) { console.error(e); }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function loadDecodeImage(file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('decode-preview').style.display = 'block';
                document.getElementById('decode-preview-img').src = e.target.result;
                const drop = document.getElementById('decode-image-drop');
                drop.classList.add('loaded');
                drop.textContent = 'âœ“ ' + file.name;
                decodeImageLoaded = true;
                updateButtons();
            };
            reader.readAsDataURL(file);
        }

        function updateCount() {
            const msg = document.getElementById('message').value;
            const count = msg.length;
            document.getElementById('char-count').textContent = count + ' / ' + maxChars + ' characters';
            const cap = document.getElementById('capacity');
            cap.classList.remove('warning', 'danger');
            if (count > maxChars) cap.classList.add('danger');
            else if (count > maxChars * 0.8) cap.classList.add('warning');
        }

        function updateButtons() {
            document.getElementById('encode-btn').disabled = !imageLoaded;
            document.getElementById('decode-btn').disabled = !decodeImageLoaded;
        }

        async function encode() {
            const message = document.getElementById('message').value;
            const imageData = document.getElementById('preview-img').src;
            const password = document.getElementById('encode-password').value;
            const status = document.getElementById('encode-status');
            status.className = 'status show loading';
            status.textContent = password ? 'Encrypting & encoding message...' : 'Encoding message...';
            try {
                const res = await fetch(API + '/api/encode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message, image: imageData, password})
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                encodedImageData = data.image;
                document.getElementById('encoded-img').src = data.image;
                document.getElementById('encode-output').style.display = 'block';
                status.className = 'status show success';
                status.textContent = 'âœ“ Encoded ' + data.messageLength + ' characters';
            } catch (e) {
                status.className = 'status show error';
                status.textContent = 'âœ— ' + e.message;
            }
        }

        async function decode() {
            const imageData = document.getElementById('decode-preview-img').src;
            const password = document.getElementById('decode-password').value;
            const status = document.getElementById('decode-status');
            status.className = 'status show loading';
            status.textContent = password ? 'Decoding & decrypting message...' : 'Decoding message...';
            try {
                const res = await fetch(API + '/api/decode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image: imageData, password})
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                document.getElementById('decoded-text').textContent = data.message;
                document.getElementById('decoded-output').style.display = 'block';
                status.className = 'status show success';
                status.textContent = 'âœ“ Decoded ' + data.length + ' characters';
            } catch (e) {
                status.className = 'status show error';
                status.textContent = 'âœ— ' + e.message;
            }
        }

        async function download(format) {
            if (!encodedImageData) return;
            const status = document.getElementById('encode-status');
            async function dataUrlToBlob(dataUrl, mimeType) {
                if (mimeType === 'image/webp') {
                    return new Promise(resolve => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            canvas.getContext('2d').drawImage(img, 0, 0);
                            canvas.toBlob(resolve, 'image/webp', 1.0);
                        };
                        img.src = dataUrl;
                    });
                }
                const res = await fetch(dataUrl);
                return res.blob();
            }
            const mimeType = format === 'webp' ? 'image/webp' : 'image/png';
            const blob = await dataUrlToBlob(encodedImageData, mimeType);
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'encoded_image.' + format,
                        types: [{ description: format.toUpperCase() + ' Image', accept: { [mimeType]: ['.' + format] } }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    status.className = 'status show success';
                    status.textContent = 'âœ“ Saved: ' + handle.name;
                    return;
                } catch (err) {
                    if (err.name === 'AbortError') return;
                }
            }
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'encoded_image.' + format;
            link.click();
            URL.revokeObjectURL(url);
            status.className = 'status show success';
            status.textContent = 'âœ“ Download started';
        }

        // Check source text status
        fetch(API + '/api/status').then(r => r.json()).then(data => {
            const el = document.getElementById('source-status');
            if (data.sourceLoaded) {
                el.textContent = 'âœ“ Source text loaded: ' + data.sourceChars.toLocaleString() + ' chars';
            } else {
                el.textContent = 'âœ— Source text not loaded';
                el.classList.add('error');
            }
        }).catch(() => {
            document.getElementById('source-status').textContent = 'âœ— Server not running - start with run.bat';
            document.getElementById('source-status').classList.add('error');
        });

        function toggleHideMessage() {
            const textarea = document.getElementById('message');
            const checkbox = document.getElementById('hide-message');
            textarea.classList.toggle('hidden-text', checkbox.checked);
        }

        setupFileDrop('image-drop', 'image-file', loadImage);
        setupFileDrop('decode-image-drop', 'decode-image-file', loadDecodeImage);
    </script>
</body>
</html>
